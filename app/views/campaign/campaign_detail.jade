extends ../layouts/user_base

append headExt
  link(rel="stylesheet" href="/css/photo_album.css")
  link(rel="stylesheet" href="/css/campaign_detail.css")
  if role=='HR' || campaign.campaign_type != 3 && role=='LEADER'
    link(rel="stylesheet" href="/lib/pen/src/pen.css")
block contentExt
  .dl_detail_container.clearfix(ng-controller="campaignController" ng-init="campaign_id='#{campaign._id}';campaign_type='#{campaign.campaign_type}';member=#{JSON.stringify(campaign.member)};join=#{join};role='#{role}';campaign_team=#{JSON.stringify(campaign.team)};user_team=#{JSON.stringify(user.team)};")
    include ../partials/breadcrumb
    +breadcrumb(links)
    .dl_detail_main
      //-TODO:详情页权限不正确，需要更改
      if (role==='HR' || role==='LEADER' && campaign.campaign_type != 3) && campaign.active &&!campaign.finish
        span.pull-right
          button.cancel_btn.dl_btn_small.operator_btn(ng-click="cancel(campaign_id)") 关闭活动
      ul.nav.nav-tabs
        li.tab_style(ng-class="{'active':true}")
          a.subtitle.no_radius.border_red= campaign.theme

      .dl_detail_border.clearfix
        .dl_detail_content
          .dl_detail_row
            .dl_detail_label
              span #{__("CAMPAIGN")}#{__("START_TIME")}:
            .dl_detail_detail
              span= moment(campaign.start_time).format("YYYY-MM-DD HH:mm dddd")
          .dl_detail_row
            .dl_detail_label
              span #{__("CAMPAIGN")}#{__("END_TIME")}:
            .dl_detail_detail
              span= moment(campaign.end_time).format("YYYY-MM-DD HH:mm dddd")
          .dl_detail_row
            .dl_detail_label
              span #{__("ENTRY")}#{__("DEADLINE")}:
            .dl_detail_detail
              span= moment(campaign.deadline).format("YYYY-MM-DD HH:mm dddd")
          .dl_detail_row
            .dl_detail_label
              span #{__("CAMPAIGN")}#{__("PLACE")}#{__("LOCATION")}:
            .dl_detail_detail
              span= campaign.location.name
          if campaign.member_min>0
            .dl_detail_row
              .dl_detail_label
                span #{__("LEAST")}#{__("ENTRY")}#{__("SUM")}:
              .dl_detail_detail
                span= campaign.member_min
          if campaign.member_max>0
            .dl_detail_row
              .dl_detail_label
                span #{__("ENTRY")}#{__("SUM")}#{__("LIMIT")}:
              .dl_detail_detail
                span= campaign.member_max
        .dl_detail_aside
            img.img_contain.size_128(ng-src="#{campaignLogo}")
            if campaign.active && (role==='MEMBER' ||role ==='LEADER') && !campaign.finish
              .dl_button_container
                input.dl_btn.dl_btn_medium(type = "button" value = "#{__('QUIT')}#{__('CAMPAIGN')}" ng-click="quitCampaign()" ng-if="join==1")
                input.dl_btn.dl_btn_medium(type = "button" value = "#{__('ENTRY')}#{__('JOIN')}" ng-click="joinReady()" ng-if="join!==1" ng-disabled="join==0")
      .dl_detail_member.row
        .dl_row.subtitle(ng-init="baseContent=true;")
          span #{__("CAMPAIGN")}#{__("SIMPLE")}#{__("INTRODUCTION")}:
          a.pull-right(ng-show="showFold" ng-click="baseContent=!baseContent;")(ng-cloak) {{baseContent ? '展开' :'收缩'}}
          if role=='HR' || campaign.campaign_type != 3 && role=='LEADER'
            span.pull-right(ng-show="showFold") |
            a.pull-right(ng-click="editContent()")(ng-cloak) {{editContentStatus ? '保存' :'编辑'}}
        .dl_detail_row
            #campaignContent.dl_word_break.contentContainer(ng-class="{'base_content':baseContent}" max-height=77 ng-show="!editContentStatus")!= campaign.content
            if role=='HR' || campaign.campaign_type != 3 && role=='LEADER'
              #campaignDetailToolBar
              #campaignDetail.markdownContainer(ng-show="editContentStatus" ng-model="campaignContent"  mix-maxlength=4000 contenteditable)
      if !campaign.active
        .dl_detail_row.text-center.margin_top_30
          span #{__("CAMPAIGNCLOSE")}
      else if campaign.finish
        .dl_detail_row.text-center.margin_top_30
          span #{__("CAMPAIGNFINISH")}

      if campaign.campaign_type == 3
        //-成员
        .dl_detail_member.row(ng-repeat="member_team in campaign_team")
          .dl_row.subtitle(bs-popover)
            .pull-left {{member_team.name}} #{__("JOIN")}#{__("MEMBER")}:
            if role === 'HR' || role === 'LEADER'
              a.pull-right(ng-click="modalPerticipator($index)" ng-if="(member_team.leader || role=='HR') && member_team.join_member.length > 0") 发通知
          .dl_row
            div.member(ng-repeat = "_member in member_team.join_member")
              a.item(href="/users/home/{{_member.uid}}" ng-Mouseenter="showUserCard(_member.uid,_member.uid)" id='pop{{_member.uid}}' rel='popover')
                img.img_contain.detail_photo.img_user(ng-src="{{_member.photo}}")
                span.name(ng-cloak) {{shortTrim(_member.nickname)}}
            span.info_label(ng-if="member_team.join_member.length == 0 || !member_team.join_member.length") 该队还没有人参加哦!
      else
        .dl_detail_member(bs-popover)
          .dl_row.subtitle
            .pull-left #{__("JOIN")}#{__("MEMBER")}:
            if role === 'HR' || role === 'LEADER'
              a.pull-right(ng-click="modalPerticipator()" ng-if="member.length > 0") 发通知
          .dl_row
            div.member(ng-repeat = "_member in member")
              a.item(href="/users/home/{{_member.uid}}" ng-Mouseenter="showUserCard(_member.uid,_member.uid)" id='pop{{_member.uid}}' rel='popover')
                img.img_contain.detail_photo.img_user(ng-src="{{_member.photo}}")
                span.name(ng-cloak) {{shortTrim(_member.nickname)}}
            span.info_label(ng-if="!member.length") 该活动还没有人参加哦!
      if role==='HR' || role ==='LEADER'
        .dl_detail_member(ng-init="member_quit=#{JSON.stringify(campaign.member_quit)};" ng-show="member_quit.length>0" bs-popover)
          p.subtitle 退出#{__("MEMBER")}:
          div.member(ng-repeat = "_member in member_quit")
            a.item(href="/users/home/{{_member.uid}}" ng-Mouseenter="showUserCard(_member.uid,_member.uid)" id='pop{{_member.uid}}' rel='popover')
              img.img_contain.detail_photo.img_user(ng-src="{{_member.photo}}")
              span.name(ng-cloak) {{shortTrim(_member.nickname)}}
      .dl_row.clearfix.commment_box(ng-if="role!='HR' || comments.length>0" bs-popover)
        p.subtitle 留言
        if role==='MEMBER' || role ==='LEADER'
          form(name="comment_form" novalidate)
            .dl_row.clearfix
              textarea.dl-form-control(rows="2" name="content" ng-model="new_comment.text" placeholder="留言请控制在140字以内" maxlength=140 required)
              button.dl_btn.dl_btn_submit.pull-right(ng-click="comment()" ng-disabled="comment_form.$invalid") #{__("SUBMIT")}#{__("LEAVEMESSAGE")}
        .comment.clearfix(ng-repeat="comment in comments")
          .comment_user_info
            a(href="/users/home/{{comment.poster._id}}" )
              img.user_photo.size_56.img_user(ng-src="{{comment.poster.photo}}" ng-Mouseenter="showUserCard(comment.poster._id,comment._id)" id='pop{{comment._id}}' rel='popover')
            a.dl_user_name_small(href="/users/home/{{comment.poster._id}}")(ng-cloak) {{comment.poster.nickname}}
          .comment_content_panel
            .relative
              .triangle_border
              .triangle
              .comment_content
                p(ng-cloak) {{comment.content}}
            .comment_date.text {{comment.create_date | date:'yyyy-MM-dd HH:mm' | dateView}}
              a.mouse_hidden.comment_date.text.pull-right(ng-if="comment.delete_permission" ng-click="deleteComment($index)") 删除
    .dl_detail_side
      .map_container
        p.subtitle.locationtitle #{__("CAMPAIGN")}#{__("LOCATION")}
        //- if campaign.location.coordinates.length==2
        //-   a(href="http://api.map.baidu.com/marker?location=#{campaign.location.coordinates[1]},#{campaign.location.coordinates[0]}&title=活动地点&content=#{campaign.location.name}&output=html" target="_blank")
        //-     img.map_size(src="http://api.map.baidu.com/staticimage?width=268&height=210&center=#{campaign.location.coordinates[0]},#{campaign.location.coordinates[1]}&zoom=15&markers=#{campaign.location.name}|#{campaign.location.coordinates[0]},#{campaign.location.coordinates[1]}&markerStyles=m,A,0xff0000&labels=#{campaign.location.name}|#{campaign.location.coordinates[0]},#{campaign.location.coordinates[1]}&labelStyles=#{campaign.location.name},1,14,0xffffff,0x000fff,1")
        //- else
        //-   img.map_size(src="/img/sign_bg.jpg")
        if campaign.location.coordinates.length==2
          a(href="http://mo.amap.com/?q=#{campaign.location.coordinates[1]},#{campaign.location.coordinates[0]}&name=#{campaign.location.name}" target="_blank")
            img.map_size(src="http://restapi.amap.com/v3/staticmap?location=#{campaign.location.coordinates[0]},#{campaign.location.coordinates[1]}&zoom=15&size=268*210&markers=mid,,A:#{campaign.location.coordinates[0]},#{campaign.location.coordinates[1]}&labels=#{campaign.location.name.replace(/ /g, '')},2,0,12,0xffffff,0x3498db:#{campaign.location.coordinates[0]},#{campaign.location.coordinates[1]}&key=077eff0a89079f77e2893d6735c2f044")
        else
          img.map_size(src="/img/icons/nomap.jpg")
      .photo_container
          .clearfix
            p.subtitle.pull-left #{__("CAMPAIGN")}#{__("WONDERFUL")}#{__("PHOTO")}
            if role!=='PARTNER'
              a.pull-right(href="/photoAlbumDetailView/#{campaign.photo_album._id}") 上传活动照片
          .photo_album
            each photo in photo_thumbnails
              a.thumbnail_cell(href="/photoView/#{campaign.photo_album._id}/#{photo._id}")
                img.thumbnail_img.img-thumbnail(src="#{photo.thumbnail_uri}")
                p.thumbnail_name.text-center= photo.name
    .modal.fade#sponsorMessageCampaignModel(tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true")
      include ../partials/campaign_message_send
    .modal.fade#joinTeamSelectmodal(tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true")
      include ../campaign/select_team_for_multi_campaign
append footExt
  script(src="/js/controllers/campaign.js")
  if role=='HR' || campaign.campaign_type != 3 && role=='LEADER'
    script(src="/lib/pen/src/pen.js")
    script(src="/lib/pen/src/markdown.js")