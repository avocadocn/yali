extends ../layouts/user_base

append headExt
  link(rel="stylesheet" href="/css/campaign_detail.css")
block contentExt
  .campaign_detail.dl_container(ng-controller="campaignController")
    .breadcrumb
    .campaign_panel
      .main_panel
        .component.detail_card
          .component_head
            span.title #{campaign.theme}
            span.sub_title #{campaign.campaign_unit[0].team.name || campaign.campaign_unit[0].company.name}
            if allow.edit
              span.sub_title.right_title.operator(ng-click="toggleEdit()") 编辑
            if !isEnd
              span.sub_title.right_title.operator(ng-if="isJoin" ng-click="quit()") 退出
            if isStart && !isEnd
              span.title.right_title.starting_title 活动正在进行中
            if isEnd
              span.sub_title.right_title 活动已结束
          .component_body
            .base_info(class="#{helper.multiUnit('multi_team')}")
              .logo_container
                each unit in campaign.campaign_unit
                  .unit
                    img.logo(src="#{unit.team.logo || unit.company.logo}/80/80")
                    if unit.team._id
                      button.join(ng-if="!isJoin" ng-click="join('#{unit.company._id}', '#{unit.team._id}')") 参加
                    else
                      button.join(ng-if="!isJoin" ng-click="join('#{unit.company._id}')") 参加
              .info_container
                if !isStart
                  .start_info
                    .campaign_info
                      p.main_text 开始时间: #{moment(campaign.start_time).format('YYYY-MM-DD HH:mm')}
                      p.main_text 结束时间: #{moment(campaign.end_time).format('YYYY-MM-DD HH:mm')}
                      p.main_text 活动地点: #{campaign.location.name}
                      p.main_text 活动类型: #{campaign.campaign_mold}
                    .time_info
                      p.text 距活动开始还有
                      p.remind(count-down="#{campaign.start_time}")
                .notice
                  p: span.title 最新公告
                  if notice
                    p.main_text #{notice.content}
                    p.text #{moment(notice.post_date).format('YYYY-MM-DD HH:mm')}
                  else
                    p.main_text 没有最新公告
            if !isStart
              .more_info
                h4.title 活动简介
                div.text(ng-if="!editing") #{campaign.content}
                input(ng-if="editing" type="text" ng-init="campaignData.content='#{campaign.content||''}'" ng-model="campaignData.content")
                h4.title 活动标签
                .tags
                  each tag in campaign.tags
                    span.tag #{tag}
                h4.title 报名信息
                if campaign.member_max
                  div.text
                    span.sub_title 报名人数上限:
                    .progress
                      .progress-bar(role="progressbar" aria-valuenow="#{campaign.members.length}" aria-valuemin="0" aria-valuemax="#{campaign.member_max}" style="width: #{campaign.members.length*100/campaign.member_max}%")
                    span #{campaign.members.length}/#{campaign.member_max}
                div.text.editing(ng-init="campaignData.member_max='#{campaign.member_max||''}'" ng-if="editing")
                  span.sub_title 报名人数上限:
                  input.people_count(type="number" ng-model="campaignData.member_max")
                  span 人 (到达后停止报名)
                if campaign.member_min
                  p.text
                    span.sub_title 报名人数下限:
                    span #{campaign.member_min}人
                div.text.editing(ng-init="campaignData.member_min='#{campaign.member_min||''}'" ng-if="editing")
                  span.sub_title 报名人数下限:
                  input.people_count(type="number" ng-model="campaignData.member_min")
                  span 人 (报名截止前未达最少人数，您将收到提醒)
                if campaign.deadline
                  p.text
                    span.sub_title 报名截止日期:
                    span #{moment(campaign.deadline).format('YYYY-MM-DD HH:mm')}
                .operator(ng-if="editing")
                  button.cancel(ng-click="toggleEdit()") 取消
                  button.save(ng-click="save()") 保存

      .panel_divider

      .side_panel

        .component.map_card(class="#{helper.start('order-2')} #{helper.end('order-5')}")
          .component_head
            img.component_logo(src="/img/map-pin-circle.png")
            span.title 活动地点
            a.head_button(href="http://mo.amap.com/?q=#{campaign.location.coordinates[1]},#{campaign.location.coordinates[0]}&name=#{campaign.location.name}" target="_blank") 大图
          .component_body
            if campaign.location.coordinates.length==2
              a(href="http://mo.amap.com/?q=#{campaign.location.coordinates[1]},#{campaign.location.coordinates[0]}&name=#{campaign.location.name}" target="_blank")
                img.img-responsive(src="http://restapi.amap.com/v3/staticmap?location=#{campaign.location.coordinates[0]},#{campaign.location.coordinates[1]}&zoom=15&size=240*170&markers=mid,,A:#{campaign.location.coordinates[0]},#{campaign.location.coordinates[1]}&labels=#{campaign.location.name.replace(/ /g, '')},2,0,12,0xffffff,0x3498db:#{campaign.location.coordinates[0]},#{campaign.location.coordinates[1]}&key=077eff0a89079f77e2893d6735c2f044")
            else
              img.img-responsive(src="/img/icons/nomap.jpg")

        .component.member_card(class="#{helper.start('order-3')} #{helper.end('order-4')}")
          .component_head
            img.component_logo(src="/img/people-general.png")
            span.title 活动成员(#{campaign.members.length})
            button.head_button 查看
          .component_body
            .member_list
              each member in membersForCard
                img.member(src="#{member.photo}/32/32")

        if isStart
          .component.brief_card(class="#{helper.start('order-1')} #{helper.end('order-2')}")
            .component_head
              span.title 活动信息
              button.head_button 详情
            .component_body
              p.text 开始: #{moment(campaign.start_time).format('YYYY-MM-DD HH:mm ddd')}
              p.text 结束: #{moment(campaign.end_time).format('YYYY-MM-DD HH:mm ddd')}
              p.text 地点: #{campaign.location.name}
              p.text 类型: #{campaign.campaign_mold}

    #campaign_data(data-id="#{campaign._id}" data-start="#{isStart}" data-end="#{isEnd}" data-join="#{isJoin}")

append footExt
  script(src="/js/controllers/campaign.js")
  script(src="/js/directives/count_down.js")
