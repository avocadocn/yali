/*! yali */

"use strict";angular.module("donler.components.campaignCard",[]).controller("CampaignCardCtrl",["$scope","Campaign",function($scope,Campaign){this.join=function(cid,tid,item){Campaign.join({campaignId:item.id,cid:cid,tid:tid},function(err){err?alertify.alert("参加失败"):(alertify.alert("参加成功"),item.isJoin=!0)})},this.quit=function(item){alertify.confirm("确定要退出该活动吗？",function(e){e&&Campaign.quit(item.id,function(err){err?alertify.alert("退出失败"):(alertify.alert("退出成功"),item.isJoin=!1)})})}}]).directive("campaignCard",function(){return{restrict:"E",replace:!0,scope:{item:"=",role:"@",cid:"@",tid:"@"},templateUrl:"/components/campaignCard/template",controller:"CampaignCardCtrl",link:function(scope,ele,attrs,ctrl){scope.join=function(cid,tid){ctrl.join(cid,tid,scope.item)},scope.quit=function(){ctrl.quit(scope.item)}}}}),angular.module("donler.components",["donler.components.richComment","donler.components.scoreBoard","donler.components.imageBox","donler.components.campaignCard"]),angular.module("donler.components.imageBox",[]).controller("ImageBoxCtrl",["$scope",function($scope){$scope.thumbBoxInnerStyle={},this.maxScrollWidth=0,this.maxShowThumbCount=0,this.thumbWidth=60;var self=this;$scope.canPrev=!1,$scope.canNext=!1,$scope.setMargin=function(index){var correctIndex=0;$scope.images.length>self.maxShowThumbCount&&(correctIndex=index-parseInt((self.maxShowThumbCount-1)/2)),0>correctIndex&&(correctIndex=0);var marginWidth=self.thumbWidth*correctIndex;if(self.maxScrollWidth>0){marginWidth>self.maxScrollWidth&&(marginWidth=self.maxScrollWidth);var margin=0-marginWidth+"px";$scope.thumbBoxInnerStyle={"margin-left":margin}}$scope.canPrev=0===marginWidth?!1:!0,$scope.canNext=marginWidth>=self.maxScrollWidth?!1:!0}}]).directive("imageBox",function(){return{restrict:"E",replace:!0,scope:{images:"="},templateUrl:"/components/ImageBox/template",controller:"ImageBoxCtrl",link:function(scope,ele,attrs,ctrl){var images=scope.images;if(images.length>0){scope.isPreview=!1,scope.prevIndex=0,scope.thisIndex=0,scope.nextIndex=0,scope.previewImg=images[0].uri;var pageIndex=0,setIndex=function(index){0>=index?(scope.prevIndex=0,scope.nextIndex=Math.min(index+1,images.length-1),scope.thisIndex=0):index>=images.length-1?(scope.prevIndex=Math.max(index-1,0),scope.nextIndex=images.length-1,scope.thisIndex=images.length-1):(scope.prevIndex=index-1,scope.nextIndex=index+1,scope.thisIndex=index),pageIndex=scope.thisIndex,scope.previewImg=images[scope.thisIndex].uri,scope.setMargin(scope.thisIndex)};scope.choose=function(index){setIndex(index)},scope.preview=function(index){setIndex(index),scope.isPreview=!0},scope.prev=function(){setIndex(scope.thisIndex-1)},scope.next=function(){setIndex(scope.thisIndex+1)},scope.close=function(){scope.isPreview=!1},scope.prevList=function(){scope.canPrev&&(pageIndex-=ctrl.maxShowThumbCount,scope.setMargin(pageIndex))},scope.nextList=function(){scope.canNext&&(pageIndex+=ctrl.maxShowThumbCount,scope.setMargin(pageIndex))}}}}}).directive("calWidth",function(){return{require:"^imageBox",restrict:"A",link:function(scope,ele,attrs,ctrl){var maxScrollWidth=ctrl.thumbWidth*scope.images.length-ele.width();if(maxScrollWidth>0){var count=parseInt(maxScrollWidth/ctrl.thumbWidth),remainder=maxScrollWidth%ctrl.thumbWidth;0!=remainder&&(maxScrollWidth=ctrl.thumbWidth*(count+1))}ctrl.maxScrollWidth=maxScrollWidth,ctrl.maxShowThumbCount=parseInt(ele.width()/ctrl.thumbWidth)}}}).directive("needScroll",function(){return{require:"^imageBox",restrict:"A",link:function(scope,ele){var lastHeight=0;scope.$watch("previewImg",function(newVal){if(newVal){var img=new Image;img.src=newVal,img.onload=function(){(this.height>document.body.clientHeight||lastHeight>document.body.clientHeight)&&window.scrollTo(0,ele[0].offsetTop),lastHeight=this.height}}})}}}),angular.module("donler.components.richComment",["angularFileUpload"]).controller("RichCommentCtrl",["$scope","$http","$element","$timeout","Comment","Report","FileUploader",function($scope,$http,$element,$timeout,Comment,Report,FileUploader){$scope.pages=[],$scope.nowPage=0,$scope.showMoreComment=!1;var CommentBox=function(args){Object.defineProperty(this,"photo_album_id",{set:function(value){this.uploader.url="/photoAlbum/"+value+"/photo/single"}}),args&&(this.host_type=args.host_type,this.host_id=args.host_id,this.photo_album_id=args.photo_album_id);var uploader=new FileUploader({url:this.photo_album_id?"/photoAlbum/"+this.photo_album_id+"/photo/single":null});uploader.filters.push({name:"imageFilter",fn:function(item){var type="|"+item.type.slice(item.type.lastIndexOf("/")+1)+"|";return-1!=="|jpg|png|jpeg|bmp|gif|".indexOf(type)}}),uploader.onAfterAddingAll=function(){$scope.afterRender&&$timeout(function(){$scope.afterRender()})},this.uploader=uploader};CommentBox.prototype.publish=function(content,callback){if(content||""!==content){var self=this;if(self.uploader.getNotUploadedItems().length>0){if(!this.uploader.url||""===this.uploader.url)return;self.uploader.uploadAll(),self.uploader.onSuccessItem=function(){$scope.afterRender&&$timeout(function(){$scope.afterRender()})},self.uploader.onCompleteAll=function(){Comment.publish({host_id:self.host_id,host_type:self.host_type,content:content},function(err,comment){self.uploader.clearQueue(),callback(err,comment)})}}else Comment.publish({host_id:self.host_id,host_type:self.host_type,content:content},function(err,comment){self.uploader.clearQueue(),callback(err,comment)})}};var cbox=new CommentBox;$scope.uploader=cbox.uploader,$scope.publish=function(content,form){cbox.publish(content,function(err,comment){err?console.log(err):($scope.comments.unshift({_id:comment._id,host_id:comment.host_id,content:comment.content,create_date:comment.create_date,poster:comment.poster,photos:comment.photos,host_type:comment.host_type,delete_permission:!0}),$scope.new_comment.text="",form.$setPristine(),$scope.afterRender&&$timeout(function(){$scope.afterRender()}))})},$scope.componentId&&$http.get("/components/RichComment/id/"+$scope.componentId).success(function(data){1===data.result&&(cbox.host_type=data.componentData.hostType,cbox.host_id=data.componentData.hostId,cbox.photo_album_id=data.componentData.photoAlbumId,$scope.photoAlbumId=data.componentData.photoAlbumId,Comment.get("campaign",cbox.host_id,function(err,comments,nextStartDate){if(err)alertify.alert("获取评论失败，请刷新页面重试");else{if($scope.comments=comments,!$scope.pages[$scope.nowPage]){var page={nextStartDate:nextStartDate};$scope.comments[0]&&(page.thisStartDate=$scope.comments[0].create_date),$scope.pages.push(page)}$scope.afterRender&&$timeout(function(){$scope.afterRender()})}}))}).error(function(){alertify.alert("获取评论失败，请刷新页面重试")}),$scope.new_comment={text:""};var getReplies=function(comment){Comment.getReplies(comment._id,function(err,replies){comment.replies=replies,comment.reply_count=replies.length})};$scope.last_reply_comment,$scope.toggleComment=function(comment){$scope.last_reply_comment&&$scope.last_reply_comment!=comment&&($scope.last_reply_comment.replying=!1),comment.replying=!comment.replying,$scope.last_reply_comment=comment,comment.replying&&(getReplies(comment),$scope.now_reply_to={_id:comment.poster._id,nickname:comment.poster.nickname},$scope.afterRender&&$timeout(function(){$scope.afterRender()}))},$scope.setReplyTo=function(comment,to,nickname){$scope.last_reply_comment!=comment&&($scope.last_reply_comment.replying=!1,$scope.last_reply_comment=comment),comment.replying||(comment.replying=!0),$scope.now_reply_to={_id:to,nickname:nickname}},$scope.reply=function(comment,form){comment.new_reply&&""!==comment.new_reply&&Comment.reply(comment._id,$scope.now_reply_to._id,comment.new_reply,function(err,reply){err||(comment.replies||(comment.replies=[]),comment.replies.push(reply),comment.reply_count++,comment.new_reply="",form.$setPristine(),$scope.afterRender&&$timeout(function(){$scope.afterRender()}))})},$scope.deleteComment=function(index){alertify.confirm("确认要删除该评论吗？",function(e){if(e)try{Comment.remove($scope.comments[index]._id,function(err){err?alertify.alert("删除失败，请重试。"):($scope.comments.splice(index,1),$scope.afterRender&&$timeout(function(){$scope.afterRender()}))})}catch(e){console.log(e)}})},$scope.removeReply=function(comment,index){alertify.confirm("确认要删除该回复吗？",function(e){if(e){var reply=comment.replies[index];Comment.remove(reply._id,function(err){err?alertify.alert("删除失败，请重试。"):(comment.replies.splice(index,1),comment.reply_count--,$scope.afterRender&&$timeout(function(){$scope.afterRender()}))})}})},$scope.getReport=function(comment){$scope.reportContent={hostType:"comment",hostContent:{_id:comment._id,content:comment.content,poster:comment.poster},reportType:""},$("#reportModal").modal("show")},$scope.pushReport=function(){Report.publish($scope.reportContent,function(err,msg){alertify.alert(msg)})},$scope.nextPage=function(){Comment.get("campaign",cbox.host_id,function(err,comments,nextStartDate){if(err)alertify.alert("获取评论失败，请刷新页面重试");else if($scope.comments=comments,$scope.nowPage++,!$scope.pages[$scope.nowPage]){var page={thisStartDate:$scope.pages[$scope.nowPage-1].nextStartDate,nextStartDate:nextStartDate};$scope.pages.push(page)}},$scope.pages[$scope.nowPage].nextStartDate)},$scope.lastPage=function(){Comment.get("campaign",cbox.host_id,function(err,comments){err?alertify.alert("获取评论失败，请刷新页面重试"):($scope.comments=comments,$scope.nowPage--)},$scope.pages[$scope.nowPage-1].thisStartDate)},$scope.changePage=function(index){Comment.get("campaign",cbox.host_id,function(err,comments){err?alertify.alert("获取评论失败，请刷新页面重试"):($scope.comments=comments,$scope.nowPage=index)},$scope.pages[index].thisStartDate)},$scope.showMore=function(){$scope.showMoreComment=!0,$scope.afterRender&&$timeout(function(){$scope.afterRender()})},$scope.originPlaceholder="输入内容请控制在140字以内",$scope.currentPlaceholder={comment:$scope.originPlaceholder,reply:$scope.originPlaceholder}}]).directive("simpleComment",function(){return{restrict:"E",replace:!0,controller:"RichCommentCtrl",scope:{componentId:"@",photoAlbumId:"@",allowPublish:"@",commentNum:"@",afterRender:"&"},templateUrl:"/components/SimpleComment/template"}}).directive("richComment",function(){return{restrict:"E",replace:!0,controller:"RichCommentCtrl",scope:{componentId:"@",photoAlbumId:"@",allowPublish:"@"},templateUrl:"/components/RichComment/template"}}),angular.module("donler.components.scoreBoard",[]).controller("ScoreBoardCtrl",["$scope","ScoreBoard",function($scope,ScoreBoard){$scope.leaderStatus="init",$scope.allowEdit=!1,$scope.allowManage=!1;var getScoreBoardData=function(){ScoreBoard.getData($scope.componentId,function(err,scoreBoardData){if(err)alertify.alert(err);else if($scope.scoreBoard=scoreBoardData,$scope.scoreBoard.effective){$scope.scores=[],$scope.results=[];for(var i=0;i<$scope.scoreBoard.playingTeams.length;i++){var playingTeam=$scope.scoreBoard.playingTeams[i];$scope.scores.push(playingTeam.score),$scope.results.push(playingTeam.result),1===$scope.scoreBoard.status?playingTeam.allowManage&&($scope.allowEdit=!0,$scope.leaderStatus=playingTeam.confirm?"waitConfirm":"toConfirm"):0===$scope.scoreBoard.status&&playingTeam.allowManage&&($scope.allowEdit=!0),playingTeam.allowManage&&($scope.allowManage=!0)}}})};getScoreBoardData(),$scope.editing=!1,$scope.setResult=function(result,index){0===index?($scope.results[0]=result,$scope.results[1]=0-result):1===index&&($scope.results[0]=0-result,$scope.results[1]=result)},$scope.toggleEdit=function(){$scope.editing=!$scope.editing};var finishEdit=function(){$scope.editing=!1,1===$scope.scoreBoard.status,$scope.leaderStatus="waitConfirm";for(var i=0;i<$scope.scoreBoard.playingTeams.length;i++){var playingTeam=$scope.scoreBoard.playingTeams[i];playingTeam.score=$scope.scores[i],playingTeam.result=$scope.results[i]}};$scope.initScore=function(){ScoreBoard.initScore($scope.componentId,{scores:$scope.scores,results:$scope.results},function(err){err?alertify.alert(err):finishEdit()})},$scope.resetScore=function(){ScoreBoard.resetScore($scope.componentId,{scores:$scope.scores,results:$scope.results},function(err){err?alertify.alert(err):finishEdit()})},$scope.confirmScore=function(){var remindMsg="提示：同意后将无法修改，确定要同意吗？";alertify.confirm(remindMsg,function(e){e&&ScoreBoard.confirmScore($scope.componentId,function(err){err?alertify.alert(err):($scope.scoreBoard.allConfirm=!0,$scope.leaderStatus="confirm",$scope.scoreBoard.status=2)})})},$scope.showLogs=!1,$scope.toggleLogs=function(){$scope.showLogs?$scope.showLogs=!1:ScoreBoard.getLogs($scope.componentId,function(err,logs){err?alertify.alert(err):($scope.logs=logs,$scope.showLogs=!0)})}}]).factory("ScoreBoard",["$http",function($http){var setScore=function(id,data,isInit,callback){$http.post("/components/ScoreBoard/id/"+id+"/setScore",{data:data,isInit:isInit}).success(function(data){1===data.result?callback():callback(data.msg)}).error(function(){callback("设置失败")})};return{getData:function(id,callback){$http.get("/components/ScoreBoard/id/"+id).success(function(data){1===data.result?callback(null,data.componentData):callback("获取比分失败，请刷新页面重试")}).error(function(){callback("获取比分失败，请刷新页面重试")})},initScore:function(id,data,callback){setScore(id,data,!0,callback)},resetScore:function(id,data,callback){setScore(id,data,!1,callback)},confirmScore:function(id,callback){$http.post("/components/ScoreBoard/id/"+id+"/confirmScore").success(function(data){1===data.result?callback():callback(data.msg)}).error(function(){callback("操作失败，请重试。")})},getLogs:function(id,callback){$http.get("/components/ScoreBoard/id/"+id+"/getLogs").success(function(data){1===data.result?callback(null,data.logs):callback(data.msg)}).error(function(){callback("获取记录失败，请重试。")})}}}]).directive("scoreBoard",function(){return{restrict:"E",replace:!0,controller:"ScoreBoardCtrl",templateUrl:"/components/ScoreBoard/template",scope:{componentId:"@"}}}),angular.module("donler",["ngRoute","ui.bootstrap","pascalprecht.translate","wu.masonry","angular-carousel","donler.components"]);var app=angular.module("donler");app.directive("match",function($parse){return{require:"ngModel",link:function(scope,elem,attrs,ctrl){scope.$watch(function(){return $parse(attrs.match)(scope)===ctrl.$modelValue},function(currentValue){ctrl.$setValidity("mismatch",currentValue)})}}}),app.directive("ngMin",function(){return{restrict:"A",require:"ngModel",link:function(scope,elem,attr,ctrl){scope.$watch("member_max",function(){void 0!=scope.member_min&&ctrl.$setViewValue(ctrl.$viewValue)});var minValidator=function(value){var min=scope.$eval(attr.ngMin)||0;return min>value?(ctrl.$setValidity("ngMin",!1),value):(ctrl.$setValidity("ngMin",!0),value)};ctrl.$parsers.push(minValidator),ctrl.$formatters.push(minValidator)}}}),app.directive("ngMax",function(){return{restrict:"A",require:"ngModel",link:function(scope,elem,attr,ctrl){scope.$watch("member_min",function(){void 0!=scope.member_max&&ctrl.$setViewValue(ctrl.$viewValue)});var maxValidator=function(value){var max=scope.$eval(attr.ngMax)||1/0;return value>max?(ctrl.$setValidity("ngMax",!1),value):(ctrl.$setValidity("ngMax",!0),value)};ctrl.$parsers.push(maxValidator),ctrl.$formatters.push(maxValidator)}}}),app.directive("bsPopover",function(){return{controller:["$http","$scope",function($http,$scope){$scope.showUserCard=function(member_id,pop_id){$scope.member_id===member_id?$("#pop"+pop_id).dl_card({content:$scope.htmlcontent}):($scope.member_id=member_id,$http.get("/users/briefInfo/"+member_id).success(function(data){$scope.htmlcontent=data,$("#pop"+pop_id).dl_card({content:data})}))},$scope.showGroupCard=function(group_id,pop_id){$scope.group_id===group_id?$("#pop"+pop_id).dl_card({content:$scope.htmlcontent}):($scope.group_id=group_id,$http.get("/group/briefInfo/"+group_id).success(function(data){$("#pop"+pop_id).dl_card({content:data}),$scope.htmlcontent=data}))}}]}}),app.directive("contenteditable",function(){return{restrict:"A",require:"ngModel",link:function(scope,element,attr,ngModel){var read;if(ngModel){ngModel.$render=function(){return element.html(ngModel.$viewValue)};var changeBind=function(){var htmlContent=$.trim(element.html());return ngModel.$viewValue!==htmlContent?(htmlContent.replace(/<\/?[^>]*>/g,"").replace(/[\u4e00-\u9fa5]/g,"**").length>attr.mixMaxlength?ngModel.$setValidity("mixlength",!1):ngModel.$setValidity("mixlength",!0),scope.$apply(read)):void 0},clearStyle=function(e){var before=e.currentTarget.innerHTML;setTimeout(function(){for(var after=e.currentTarget.innerHTML,pos1=-1,pos2=-1,i=0;i<after.length;i++)-1==pos1&&before.substr(i,1)!=after.substr(i,1)&&(pos1=i),-1==pos2&&before.substr(before.length-i-1,1)!=after.substr(after.length-i-1,1)&&(pos2=i);var pasted=after.substr(pos1,after.length-pos2-pos1),replace=pasted.replace(/style\s*=(['\"\s]?)[^'\"]*?\1/gi,"").replace(/class\s*=(['\"\s]?)[^'\"]*?\1/gi,""),replaced=after.substr(0,pos1)+replace+after.substr(pos1+pasted.length);e.currentTarget.innerHTML=replaced},100)};return element.bind("focus",function(){element.bind("keydown",changeBind),element.bind("paste",clearStyle)}),element.bind("blur",function(e){element.unbind("keydown",changeBind),element.unbind("paste",clearStyle),changeBind(e)}),read=function(){return ngModel.$setViewValue($.trim(element.html()))}}}}}),app.directive("mixMaxlength",function(){return{restrict:"A",require:"ngModel",link:function(scope,ele,attrs,ctrl){var length=parseInt(attrs.mixMaxlength)||10;scope.$watch(attrs.ngModel,function(newValue){newValue&&newValue.replace(/[\u4e00-\u9fa5]/g,"**").length>length?ctrl.$setValidity("mixlength",!1):ctrl.$setValidity("mixlength",!0)})}}}),app.directive("bootstrapTagsinput",[function(){function getItemProperty(scope,property){return property?angular.isFunction(scope.$parent[property])?scope.$parent[property]:function(item){return item[property]}:void 0}return{restrict:"EA",scope:{model:"=ngModel"},template:"<select multiple></select>",replace:!1,link:function(scope,element,attrs){$(function(){angular.isArray(scope.model)||(scope.model=[]);var select=$("select",element),typeaheadSourceArray=attrs.typeaheadSource?attrs.typeaheadSource.split("."):null,typeaheadSource=typeaheadSourceArray?typeaheadSourceArray.length>1?scope.$parent[typeaheadSourceArray[0]][typeaheadSourceArray[1]]:scope.$parent[typeaheadSourceArray[0]]:null;select.tagsinput(scope.$parent[attrs.options||""]||{typeahead:{source:angular.isFunction(typeaheadSource)?typeaheadSource:null},itemValue:getItemProperty(scope,attrs.itemvalue),itemText:getItemProperty(scope,attrs.itemtext),confirmKeys:getItemProperty(scope,attrs.confirmkeys)?JSON.parse(attrs.confirmkeys):[13],tagClass:angular.isFunction(scope.$parent[attrs.tagclass])?scope.$parent[attrs.tagclass]:function(){return attrs.tagclass}});for(var i=0;i<scope.model.length;i++)select.tagsinput("add",scope.model[i]);select.on("itemAdded",function(event){-1===scope.model.indexOf(event.item)&&scope.model.push(event.item)}),select.on("itemRemoved",function(event){var idx=scope.model.indexOf(event.item);-1!==idx&&scope.model.splice(idx,1)});var prev=scope.model.slice();scope.$watch("model",function(){var i,added=scope.model.filter(function(i){return-1===prev.indexOf(i)}),removed=prev.filter(function(i){return-1===scope.model.indexOf(i)});for(prev=scope.model.slice(),i=0;i<removed.length;i++)select.tagsinput("remove",removed[i]);for(select.tagsinput("refresh"),i=0;i<added.length;i++)select.tagsinput("add",added[i])},!0)})}}}]),app.directive("ngThumb",["$window",function($window){var helper={support:!(!$window.FileReader||!$window.CanvasRenderingContext2D),isFile:function(item){return angular.isObject(item)&&item instanceof $window.File},isImage:function(file){var type="|"+file.type.slice(file.type.lastIndexOf("/")+1)+"|";return-1!=="|jpg|png|jpeg|bmp|gif|".indexOf(type)}};return{restrict:"A",template:"<canvas/>",link:function(scope,element,attributes){function onLoadFile(event){var img=new Image;img.onload=onLoadImage,img.src=event.target.result}function onLoadImage(){var width=params.width||this.width/this.height*params.height,height=params.height||this.height/this.width*params.width;canvas.attr({width:width,height:height}),canvas[0].getContext("2d").drawImage(this,0,0,width,height)}if(helper.support){var params=scope.$eval(attributes.ngThumb);if(helper.isFile(params.file)&&helper.isImage(params.file)){var canvas=element.find("canvas"),reader=new FileReader;reader.onload=onLoadFile,reader.readAsDataURL(params.file)}}}}}]),app.run(["$rootScope",function($rootScope){alertify.set({buttonFocus:"none",labels:{ok:"确认",cancel:"取消"}}),$rootScope.shortTrim=function(value){return escape(value).indexOf("%u")>=0?value.length>6?value.substr(0,6)+"...":value:value.length>15?value.substr(0,15)+"...":value}}]),app.filter("dateView",function(){return function(input){var today=new Date;today.setHours(0),today.setMinutes(0),today.setSeconds(0);var date=new Date(input),intervalMilli=date.getTime()-today.getTime(),xcts=Math.floor(intervalMilli/864e5),nowTime=(date.getHours()<10?"0"+date.getHours():date.getHours())+":"+(date.getMinutes()<10?"0"+date.getMinutes():date.getMinutes());switch(xcts){case-2:return"前天"+nowTime;case-1:return"昨天"+nowTime;case 0:return"今天"+nowTime;case 1:return"明天"+nowTime;case 2:return"后天"+nowTime;default:return input}}}),app.filter("day",function(){return function(input){var today=new Date;today.setHours(0),today.setMinutes(0),today.setSeconds(0);var date=new Date(input),intervalMilli=date.getTime()-today.getTime(),xcts=Math.floor(intervalMilli/864e5);switch(xcts){case-1:return"昨天";case 0:return"今天";case 1:return"明天";default:return date.getMonth()+1+"-"+date.getDate()}}}),app.filter("week",function(){return function(input){switch(new Date(input).getDay()){case 0:input="周日";break;case 1:input="周一";break;case 2:input="周二";break;case 3:input="周三";break;case 4:input="周四";break;case 5:input="周五";break;case 6:input="周六";break;default:input=""}return input}}),angular.module("donler").factory("Campaign",["$http",function($http){var sponsor=function(_url,_data,callback){try{$http({method:"post",url:_url,data:_data}).success(function(data){callback(null,data)}).error(function(){callback("error")})}catch(e){console.log(e)}},getTags=function(hostType,hostId,callback){$http.get("/"+hostType+"/getTags/"+hostId).success(function(data){callback(null,data)}).error(function(){callback("error")})},getMolds=function(hostType,hostId,callback){$http.get("/campaign/getMolds/"+hostType+"/"+hostId).success(function(data){0===data.result?callback(data.msg):callback(null,data)}).error(function(){callback("error")})},join=function(data,callback){$http.post("/campaign/joinCampaign/"+data.campaignId,{cid:data.cid,tid:data.tid}).success(function(data){1===data.result?callback():callback(data.msg)}).error(function(){callback("参加失败，请重试。")})},quit=function(campaignId,callback){$http.post("/campaign/quitCampaign/"+campaignId).success(function(data){1===data.result?callback():callback(data.msg)}).error(function(){callback("退出失败，请重试。")})},edit=function(campaignId,campaignData,callback){$http.post("/campaign/edit/"+campaignId,campaignData).success(function(data){1===data.result?callback():callback(data.msg)}).error(function(){callback("编辑失败，请重试。")})},cancel=function(campaignId,callback){$http.post("/campaign/cancel/"+campaignId).success(function(data){1===data.result?callback():callback(data.msg)}).error(function(){callback("关闭活动失败，请重试。")})},dealProvoke=function(campaignId,tid,status,callback){$http({method:"post",url:"/campaign/dealProvoke/"+campaignId,data:{tid:tid,responseStatus:status}}).success(function(data){1===data.result?callback():callback(data.msg)}).error(function(){callback("DATA ERROR")})},getLedTeams=function(tid,callback){if(tid)var _url="/group/getLedTeams/"+tid;else var _url="/group/getLedTeams";$http.get(_url).success(function(data){0===data.result?callback(data.msg):callback(null,data)})},getCampaignsData=function(hostType,hostId,paging,callback){var query="";paging&&paging.year&&paging.month&&(query="?year="+paging.year+"&month="+paging.month),$http.get("/campaign/getCampaignData/"+hostType+"/"+hostId+query).success(function(data){1===data.result?callback(null,data.timeLine):callback(data.msg)}).error(function(){callback("error")})},getCampaignsDateRecord=function(hostType,hostId,callback){$http.get("/campaign/getDateRecord/"+hostType+"/"+hostId).success(function(data){1===data.result?callback(null,data.dateRecord):callback(data.msg)}).error(function(){callback("error")})};return{sponsor:sponsor,getTags:getTags,join:join,quit:quit,edit:edit,cancel:cancel,getMolds:getMolds,dealProvoke:dealProvoke,getLedTeams:getLedTeams,getCampaignsData:getCampaignsData,getCampaignsDateRecord:getCampaignsDateRecord}}]),angular.module("donler").factory("Comment",["$http",function($http){var get=function(type,id,callback,create_date,num){$http.post("/comment/pull/"+type+"/"+id,{create_date:create_date,num:num}).success(function(data){callback(null,data.comments,data.nextStartDate)}).error(function(){callback("error")})},publish=function(data,callback){$http.post("/comment/push/"+data.host_type+"/"+data.host_id,data).success(function(data){"SUCCESS"===data.msg?callback(null,data.comment):callback("error")}).error(function(){callback("error")})},remove=function(comment_id,callback){$http.delete("/comment/"+comment_id).success(function(data){1===data.result?callback():callback("error")}).error(function(){callback("error")})},reply=function(comment_id,to,content,callback){$http.post("/comment/"+comment_id+"/reply",{to:to,content:content}).success(function(data){1===data.result?callback(null,data.reply):callback("error")}).error(function(){callback("error")})},getReplies=function(comment_id,callback){$http.get("/comment/"+comment_id+"/replies").success(function(data){1===data.result?callback(null,data.replies):callback("error")}).error(function(){callback("error")})};return{get:get,publish:publish,reply:reply,remove:remove,getReplies:getReplies}}]),angular.module("donler").factory("PhotoAlbum",["$http",function($http){var PhotoAlbum=function(id){this.id=id};return PhotoAlbum.prototype.getInfo=function(callback){$http.get("/photoAlbum/"+this.id).success(function(data){1===data.result?callback(null,data.data):callback(data.msg)}).error(function(){callback("error")})},PhotoAlbum.prototype.getPhotos=function(callback){$http.get("/photoAlbum/"+this.id+"/photolist").success(function(data){1===data.result?callback(null,data.data):callback(data.msg,[])}).error(function(){callback("error",[])})},PhotoAlbum.prototype.changeName=function(callback){var self=this;return function(name){$http.put("/photoAlbum/"+self.id,{name:name}).success(function(data){1===data.result?callback(null,data.data):callback(data.msg)}).error(function(){callback("error")})}},PhotoAlbum.prototype.delete=function(callback){$http.delete("/photoAlbum/"+this.id).success(function(data){1===data.result?callback():callback(data.msg)}).error(function(){callback("error")})},PhotoAlbum}]),angular.module("donler").factory("Report",["$http",function($http){var publish=function(data,callback){$http.post("/report/push/",data).success(function(data){1===data.result?callback(null,data.msg):callback("error",data.msg)}).error(function(){callback("error","数据发送错误")})};return{publish:publish}}]),angular.module("donler").factory("Search",["$http",function($http){var searchSameCity=function(tid,pageNum,callback){try{$http.get("/search/sameCityTeam/"+tid+"?page="+pageNum).success(function(data){callback(null,data)}).error(function(){callback("error")})}catch(e){console.log(e),callback("error")}},searchNearby=function(tid,pageNum,homecourtIndex,callback){try{$http.get("/search/nearbyTeam/"+tid+"?page="+pageNum+"&index="+homecourtIndex).success(function(data){callback(null,data)}).error(function(){callback("error")})}catch(e){console.log(e),callback("error")}},getOpponentInfo=function(tid,callback){$http.get("/group/opponentInfo/"+tid).success(function(data){callback(null,data)}).error(function(){callback("error")})},searchTeam=function(tid,keyword,pageNum,callback){$http.get("/search/keywordSearch/"+tid+"?key="+keyword+"&page="+pageNum).success(function(data){callback(null,data)}).error(function(){callback("error")})};return{searchSameCity:searchSameCity,getOpponentInfo:getOpponentInfo,searchNearby:searchNearby,searchTeam:searchTeam}}]);var donler=angular.module("donler");donler.factory("Team",["$http",function($http){return{getTeamInfo:function(id,callback){$http.get("/group/"+id+"/info").success(function(data){1===data.result?callback(null,{team:data.team,allow:data.allow,isShowHomeCourts:data.isShowHomeCourts,role:data.role}):callback("error")}).error(function(){callback("error")})},getTeamMembers:function(id,callback){$http.get("/group/"+id+"/members").success(function(data){1===data.result?callback(null,data.members):callback("error")}).error(function(){callback("error")})},join:function(id,callback){$http.post("/users/joinGroup",{tid:id}).success(function(data){1===data.result?callback():callback("error")}).error(function(){callback("error")})},quit:function(id,callback){$http.post("/users/quitGroup",{tid:id}).success(function(data){1===data.result?callback():callback("error")}).error(function(){callback("error")})},saveInfo:function(id,data,callback){var homecourt;if(data.homecourt){homecourt=data.homecourt;for(var i=0;i<homecourt.length;i++)homecourt[i].name||homecourt.splice(i,1)}$http.post("/group/saveInfo/"+id,{name:data.name,brief:data.brief,homecourt:homecourt}).success(function(data){1===data.result?callback():callback(data.msg)}).error(function(){callback("error")})}}}]);var messageApp=angular.module("donler");messageApp.run(["$http","$rootScope",function($http,$rootScope){$rootScope.o=0}]),messageApp.controller("messageHeaderController",["$scope","$http","$rootScope",function($scope,$http,$rootScope){"/message/home"!=location.pathname&&$http.get("/message/header").success(function(data){var messages=data.msg;$rootScope.o=messages.length})}]),function($){var $loading,$wrap,currentObj,timers=[],optsArray=[],currentOpts={},_position=function($ref,$target){var scrollTop,scrollLeft,windowHeight,windowWidth,refOffset,refHeight,refWidth,targetTop,targetLeft,targetHeight,targetWidth,originTop,originRight,originBottom,originLeft,arrowPositon,arrowSize=5,isPosition=!1;scrollTop=$(document).scrollTop(),scrollLeft=$(document).scrollLeft(),windowHeight=$(window).height(),windowWidth=$(window).width(),refOffset=$ref.offset(),refHeight=$ref.outerHeight(),refWidth=$ref.outerWidth(),targetHeight=$target.outerHeight(),targetWidth=$target.outerWidth(),refOffset.top-scrollTop-targetHeight-arrowSize>=0&&(windowWidth+scrollLeft-refOffset.left-targetWidth>=0?(targetTop=refOffset.top-targetHeight-arrowSize,targetLeft=refOffset.left,isPosition=!0,arrowPositon="b"):refOffset.left+refWidth-scrollLeft-targetWidth>=0&&(targetTop=refOffset.top-targetHeight-arrowSize,targetLeft=refOffset.left+refWidth-targetWidth,isPosition=!0,arrowPositon="b",$wrap.find(".arrow").css({left:"auto",right:"20px"}))),isPosition||windowHeight-(refOffset.top+refHeight-scrollTop)-targetHeight-arrowSize>=0&&(windowWidth+scrollLeft-refOffset.left-targetWidth>=0?(targetTop=refOffset.top+refHeight+arrowSize,targetLeft=refOffset.left,isPosition=!0,arrowPositon="t"):refOffset.left+refWidth-scrollLeft-targetWidth>=0&&(targetTop=refOffset.top+refHeight+arrowSize,targetLeft=refOffset.left+refWidth-targetWidth,isPosition=!0,arrowPositon="t",$wrap.find(".arrow").css({left:"auto",right:"20px"}))),isPosition||windowWidth+scrollLeft-refOffset.left-refWidth-targetWidth-arrowSize>=0&&(refOffset.top+refHeight-scrollTop-targetHeight>=0?(targetTop=refOffset.top+refHeight-targetHeight,targetLeft=refOffset.left+refWidth+arrowSize,isPosition=!0,arrowPositon="l",$wrap.find(".arrow").css({top:"auto",bottom:"20px"})):refOffset.top+windowHeight-scrollTop-targetHeight>=0&&(targetTop=refOffset.top,targetLeft=refOffset.left+refWidth+arrowSize,isPosition=!0,arrowPositon="l")),isPosition||refOffset.left-scrollLeft-targetWidth-arrowSize>=0&&(windowHeight-(refOffset.top-scrollTop)-targetHeight>=0?(targetTop=refOffset.top,targetLeft=refOffset.left-targetWidth-arrowSize,isPosition=!0,arrowPositon="r"):refOffset.top+refHeight-scrollTop-targetHeight>=0&&(targetTop=refOffset.top+refHeight-targetHeight,targetLeft=refOffset.left-targetWidth-arrowSize,isPosition=!0,arrowPositon="r",$wrap.find(".arrow").css({top:"auto",bottom:"20px"}))),isPosition||(originTop=refOffset.top-scrollTop+refHeight/2,originBottom=windowHeight-originTop,originLeft=refOffset.left-scrollLeft+refWidth/2,originRight=windowWidth-originLeft,originTop>=originBottom?originRight>=originLeft?targetHeight>originTop&&originRight>=targetWidth?(targetTop=refOffset.top+refHeight-targetHeight,targetLeft=refOffset.left+refWidth+arrowSize,arrowPositon="l",$wrap.find(".arrow").css({top:"auto",bottom:"20px"})):(targetTop=refOffset.top-targetHeight-arrowSize,targetLeft=refOffset.left,arrowPositon="b"):targetHeight>originTop&&originLeft>=targetWidth?(targetTop=refOffset.top+refHeight-targetHeight,targetLeft=refOffset.left-targetWidth-arrowSize,arrowPositon="r",$wrap.find(".arrow").css({top:"auto",bottom:"20px"})):(targetTop=refOffset.top-targetHeight-arrowSize,targetLeft=refOffset.left+refWidth-targetWidth,arrowPositon="b",$wrap.find(".arrow").css({left:"auto",right:"20px"})):originRight>=originLeft?targetHeight>originBottom&&originRight>=targetWidth?(targetTop=refOffset.top,targetLeft=refOffset.left+refWidth+arrowSize,arrowPositon="l"):(targetTop=refOffset.top+refHeight+arrowSize,targetLeft=refOffset.left,arrowPositon="t"):targetHeight>originBottom&&originLeft>=targetWidth?(targetTop=refOffset.top,targetLeft=refOffset.left-targetWidth-arrowSize,arrowPositon="r"):(targetTop=refOffset.top+refHeight+arrowSize,targetLeft=refOffset.left+refWidth-targetWidth,arrowPositon="t",$wrap.find(".arrow").css({left:"auto",right:"20px"})),isPosition=!0),$wrap.find(".arrow").removeClass().addClass("arrow arrow_"+arrowPositon),isPosition&&$target.css({top:targetTop,left:targetLeft})
},_appendContent=function(){var type,href,data;switch($loading=$('<div class="dl_card_loading"><div>正在加载，请稍后</div></div>'),"undefined"!=typeof $wrap?$wrap.html(""):($("body").append('<div class="dl_card"></div>'),$wrap=$(".dl_card")),$wrap.html('<div class="dl_card_layer clearfix"><div class="dl_card_content clearfix"></div><div class="arrow"></div></div>'),$wrap.find(".dl_card_content").append($loading),currentOpts=optsArray.opts,type=currentOpts.content?"html":"ajax"){case"html":$wrap.find(".dl_card_content").html(currentOpts.content);break;case"ajax":href=$(currentObj).attr("ajax-href"),data=$(currentObj).attr("ajax-data");var ajaxLoader=$.ajax({url:href,data:data||{},error:function(XMLHttpRequest){XMLHttpRequest.status>0&&window.console.log("ajax error")},success:function(data,textStatus,XMLHttpRequest){var o="object"==typeof XMLHttpRequest?XMLHttpRequest:ajaxLoader;200==o.status&&($wrap.find(".pinwheel_content").html(data),_position($(currentObj),$wrap))}})}},_clearTimer=function(){for(var i=0;i<timers.length;i++)timers[i]&&clearInterval(timers[i]);timers=[]};$.fn.dl_card=function(options){var opts=options;return this.each(function(){optsArray={obj:this,opts:opts},_clearTimer(),currentObj&&currentObj==this?(_position($(this),$wrap),$wrap.show()):(currentObj=this,_appendContent(),_position($(this),$wrap),$wrap.show(),$wrap.unbind().bind("mouseover",function(e){e.stopPropagation(),_clearTimer()}),$(this).bind("mouseleave",function(){if(_clearTimer(),$wrap.is(":visible")){var timer=setInterval(function(){$wrap.hide(),_clearTimer()},50);timers.push(timer)}}),$wrap.bind("mouseleave",function(){if(_clearTimer(),$wrap.is(":visible")){var timer=setInterval(function(){$wrap.hide(),_clearTimer()},50);timers.push(timer)}}))})}}(jQuery);
//# sourceMappingURL=library.min.js.map